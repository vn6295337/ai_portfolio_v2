name: OpenRouter Pipeline (T & U Scripts)

on:
  workflow_dispatch:  # Manual trigger only
    inputs:
      script_choice:
        description: 'Choose which script to run (mutually exclusive)'
        required: true
        default: 'none'
        type: choice
        options:
        - 'none'
        - 'run_t'
        - 'run_u'

jobs:
  openrouter-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write  # Allow writing to repository

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        cache: 'pip'

    - name: Install dependencies
      working-directory: openrouter_pipeline
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: Set environment variables
      env:
        PIPELINE_SUPABASE_URL: ${{ secrets.PIPELINE_SUPABASE_URL }}
      run: |
        echo "‚úÖ Environment variables set from GitHub secrets"
        if [ -z "$PIPELINE_SUPABASE_URL" ]; then
          echo "‚ùå ERROR: PIPELINE_SUPABASE_URL secret is not set"
          exit 1
        fi

    - name: Show execution plan
      run: |
        echo "üéØ OpenRouter Pipeline Execution Plan:"
        echo "Selected option: ${{ inputs.script_choice }}"
        if [[ "${{ inputs.script_choice }}" == "run_t" ]]; then
          echo "Will execute: T_refresh_supabase_working_version.py (Refresh Working Version + Rate Limits)"
        elif [[ "${{ inputs.script_choice }}" == "run_u" ]]; then
          echo "Will execute: U_deploy_to_ai_models_main.py (Deploy to Production)"
        else
          echo "No script will be executed (none selected)"
        fi

    - name: Run T_refresh_supabase_working_version.py
      if: ${{ inputs.script_choice == 'run_t' }}
      working-directory: openrouter_pipeline
      env:
        PIPELINE_SUPABASE_URL: ${{ secrets.PIPELINE_SUPABASE_URL }}
      run: |
        echo "üîÑ Running T_refresh_supabase_working_version.py..."
        echo "‚ö†Ô∏è  This will refresh the Supabase working_version_v3 table with OpenRouter pipeline data"
        echo "üìä This will also update ims.30_rate_limits table with parsed rate limits"
        python3 -u 01_scripts/T_refresh_supabase_working_version.py

    - name: Run U_deploy_to_ai_models_main.py
      if: ${{ inputs.script_choice == 'run_u' }}
      working-directory: openrouter_pipeline
      env:
        PIPELINE_SUPABASE_URL: ${{ secrets.PIPELINE_SUPABASE_URL }}
      run: |
        echo "üöÄ Running U_deploy_to_ai_models_main.py..."
        echo "‚ö†Ô∏è  This will deploy from working_version_v3 to ai_models_main_v3"
        python3 -u 01_scripts/U_deploy_to_ai_models_main.py

    - name: Auto-refresh ims.10_model_aa_mapping
      if: ${{ inputs.script_choice == 'run_t' }}
      working-directory: openrouter_pipeline
      env:
        PIPELINE_SUPABASE_URL: ${{ secrets.PIPELINE_SUPABASE_URL }}
      run: |
        echo "‚öôÔ∏è Installing psycopg2 for database operations..."
        pip install psycopg2-binary
        echo "üîÑ Auto-refreshing ims.10_model_aa_mapping from working_version..."
        python3 refresh_model_aa_mapping.py

    - name: Upload deployment logs
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: openrouter-deployment-logs
        path: |
          openrouter_pipeline/02_outputs/*.log
          openrouter_pipeline/02_outputs/*-deployment-*.txt
          openrouter_pipeline/02_outputs/T-*.txt
          openrouter_pipeline/02_outputs/U-*.txt
        retention-days: 7

    - name: Show completion summary
      if: success()
      run: |
        echo "‚úÖ OpenRouter pipeline deployment completed successfully"
        echo "Script executed: ${{ inputs.script_choice }}"
        if [[ "${{ inputs.script_choice }}" == "run_t" ]]; then
          echo "‚úÖ Working version table refreshed with OpenRouter data"
          echo "‚úÖ Rate limits table updated with parsed rate limits"
        elif [[ "${{ inputs.script_choice }}" == "run_u" ]]; then
          echo "‚úÖ Data deployed to main ai_models table"
        else
          echo "‚ÑπÔ∏è  No script was executed"
        fi
        echo "Check deployment logs artifact for detailed output"

    - name: Show failure summary
      if: failure()
      run: |
        echo "‚ùå OpenRouter pipeline deployment failed"
        echo "Script that failed: ${{ inputs.script_choice }}"

        echo "Check deployment logs artifact for error details"
